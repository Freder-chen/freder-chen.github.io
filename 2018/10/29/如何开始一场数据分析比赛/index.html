<!doctype html>
<html lang="zh-CN">
  <head>
	<script type="text/javascript" async
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
	</script>
  </head>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />

  
  
  

  <link rel="stylesheet" href="/css/mobi.css-3.1.1/dist/mobi.min.css">
<link rel="stylesheet" href="/css/caomei1.2.1/style.css">
<link rel="stylesheet" href="/css/theme.css">

  
    <meta name="keywords" content="Data Analysis" />
  

  
    <link rel="alternate" href="/atom.xml" title="Frederçš„åšå®¢" type="application/atom+xml" />
  

  
    <link rel="shortcut icon" href="/favicon.jpg">
  

  <title>å¦‚ä½•å¼€å§‹ä¸€åœºæ•°æ®åˆ†ææ¯”èµ› - Frederçš„åšå®¢</title>
</head>

  <body class="theme-body">
    <div class="flex-center theme-header-wrapper">
  <div class="container flex-left units-gap theme-header-container">
    <a href="/" class="unit-0 theme-header-icon theme-icon-link" title="é¦–é¡µ">
      <i class="czs-home-l"></i>
    </a>
    <div class="flex-center text-center flex-middle unit theme-header-title theme-header-title-no-transition">
      Frederçš„åšå®¢
    </div>
    <a class="unit-0 theme-header-icon theme-icon-link theme-header-sidebar-icon" href="javascript:void(0);" title="æ›´å¤š">
      <i class="czs-menu-l"></i>
    </a>
  </div>
</div>
<div class="theme-header-placeholder"></div>

    <div class="flex-center">
      <div class="container">
        <article>
  <h1 class="text-center">
    å¦‚ä½•å¼€å§‹ä¸€åœºæ•°æ®åˆ†ææ¯”èµ›
  </h1>
  <div class="text-center top-gap">
    <div class="text-small text-muted">
  <time datetime="2018-10-29T00:00:00+08:00">
    2018-10-29
  </time>
  <span class="theme-separator">Â·</span>
  <i class="czs-user-l"></i>
  <a class="text-muted theme-text-no-decoration" href="https://github.com/Freder">Freder</a>
  <span class="theme-separator">Â·</span>
  <i class="czs-bookmark-l"></i>
  <a class="text-muted theme-text-no-decoration" href="/categories/Code/">Code</a>
  <span class="theme-comment-count-container theme-hide theme-comment-count-container-transparent">
    <span class="theme-separator">Â·</span>
    <i class="czs-comment-l"></i>
    <a class="text-muted theme-text-no-decoration theme-comment-count" data-disqus-identifier="2018/10/29/å¦‚ä½•å¼€å§‹ä¸€åœºæ•°æ®åˆ†ææ¯”èµ›/" href="/2018/10/29/å¦‚ä½•å¼€å§‹ä¸€åœºæ•°æ®åˆ†ææ¯”èµ›/#disqus_thread"></a>
  </span>
</div>

  </div>
  <div class="top-gap-big">
    <p>è¯´æ¥æƒ­æ„§ï¼Œè¿™ç¯‡æ–‡ç« æ˜¯æ¯”èµ›æ—¶å°±å¼€å§‹å‡†å¤‡ï¼Œæ‹–åˆ°ç­”è¾©åæ‰å®Œæˆã€‚</p>
<p>å†™è¿™ç¯‡æ–‡ç« çš„ç¼˜ç”±æ˜¯å¼€å§‹åš<a href="http://www.dcjingsai.com/common/cmpt/2018%E7%A7%91%E5%A4%A7%E8%AE%AF%E9%A3%9EAI%E8%90%A5%E9%94%80%E7%AE%97%E6%B3%95%E5%A4%A7%E8%B5%9B_%E7%AB%9E%E8%B5%9B%E4%BF%A1%E6%81%AF.html" target="_blank" rel="external">2018ç§‘å¤§è®¯é£AIè¥é”€ç®—æ³•å¤§èµ›</a>ï¼Œ è¢«å¥½å‹é—®åˆ°å¦‚ä½•å…¥é—¨æ•°æ®åˆ†æï¼Œç”±äºæˆ‘è‡ªå·±ç®—æ˜¯é›¶åŸºç¡€è¾¹æ¯”èµ›è¾¹å­¦ï¼Œä¸€æ—¶é—´ä¸çŸ¥é“å¦‚ä½•å›ç­”ã€‚æ¯•ç«Ÿâ€œè¾“çš„æ—¶å€™è¯´ä»€ä¹ˆéƒ½æ˜¯é”™çš„â€ã€‚æœ€åå–å¾—ç¬¬å››åçš„æˆç»©å¤–å‡ºç­”è¾©å—å® è‹¥æƒŠï¼Œä¹Ÿç»™äº†æˆ‘ä¸€ç‚¹åº•æ°”èŠä¸€èŠè‡ªå·±çš„æƒ³æ³•ã€‚åŒæ—¶ï¼Œæˆ‘å¿…é¡»å¼ºè°ƒè¿™æ¬¡æ¯”èµ›å¤šäºäº†å„ä½å¤§ä½¬çš„Baselineï¼Œå¦åˆ™ä¸å¯èƒ½è·å¾—å¦‚æ­¤æˆç»©ã€‚ç§‰æ‰¿ç»§æ‰¿åˆ†äº«ç²¾ç¥çš„å¿ƒæƒ…å†™ä¸‹ä¸€ç‚¹æ‹™è§ã€‚</p>
<p>ç”±äºæˆ‘æ‰€å±çš„é˜Ÿä¼å¯¹äºç‰¹å¾å¹¶æ— è¿‡å¤šäº¤æµï¼Œä»¥è‡³äºæœ€åç­”è¾©çš„æ—¶å€™å‡ºç°äº†ä¸çŸ¥é“å¯¹æ–¹åšäº†ä»€ä¹ˆçš„å°´å°¬æƒ…å†µã€‚æ‰€ä»¥è¿™é‡Œåªèƒ½è°ˆè°ˆæˆ‘è‡ªå·±çš„ä¸€ç‚¹æ€è·¯ã€‚å¤§å¤šè§‚ç‚¹å€Ÿé‰´è¿™ç¯‡<a href="https://zhuanlan.zhihu.com/p/27033340" target="_blank" rel="external">è½¬è½½æ–‡ç« </a>ã€‚</p>
<h3 id="å¼€å¤´çš„èƒ¡è¨€ä¹±è¯­"><a href="#å¼€å¤´çš„èƒ¡è¨€ä¹±è¯­" class="headerlink" title="å¼€å¤´çš„èƒ¡è¨€ä¹±è¯­"></a>å¼€å¤´çš„èƒ¡è¨€ä¹±è¯­</h3><p>æˆ‘ä¸€ç›´è®¤ä¸ºå®æˆ˜æ˜¯æœ€å¥½çš„å…¥é—¨ææ–™ï¼Œæ•°æ®åˆ†æäº¦å¦‚æ­¤ã€‚æ‰€ä»¥ä¸è¦å®³æ€•é¢å¯¹æ¯”èµ›ä¸€è¡Œä»£ç éƒ½æ•²ä¸å‡ºæ¥ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¼šæœ‰ baseline ä½œä¸ºå‚è€ƒï¼Œç…§ç€ baseline ä¸€è¡Œä¸€è¡Œæ•²ï¼ŒæŸ¥æ¯ä¸€ä¸ªå‡½æ•°çš„æ„æ€ã€ç”¨æ³•ï¼Œæ…¢æ…¢çš„å­¦ä¼šæ€ä¹ˆä½¿ç”¨æ•°æ®åˆ†æå·¥å…·ã€‚ç„¶åå†å»è€ƒè™‘ç ”ç©¶æ¯ä¸€ä¸ªå‡½æ•°å†…éƒ¨çš„åŸç†ã€‚</p>
<h3 id="å…ˆè®©ç¨‹åºè·‘èµ·æ¥"><a href="#å…ˆè®©ç¨‹åºè·‘èµ·æ¥" class="headerlink" title="å…ˆè®©ç¨‹åºè·‘èµ·æ¥"></a>å…ˆè®©ç¨‹åºè·‘èµ·æ¥</h3><p>æˆ‘ä»¬å¯ä»¥å€Ÿé‰´ <a href="https://zhuanlan.zhihu.com/p/44956113" target="_blank" rel="external">baseline</a> ä¸­çš„æ¨¡å‹ï¼Œå°†æ‰€æœ‰åº”è¯¥å¯¼å…¥çš„åŒ…è£…å¥½ä»¥åä»¥æœ€å¿«çš„é€Ÿåº¦è·‘å‡ºä¸€ä¸ªç­”æ¡ˆã€‚</p>
<p>æ•°æ®åˆ†æçš„ä¸€èˆ¬æ­¥éª¤æ˜¯è¯»æ•°æ®ã€å¡«å……ç¼ºå¤±å€¼ã€æå–ç‰¹å¾ã€æ¨¡å‹çš„è®­ç»ƒåŠé¢„æµ‹ã€‚ä½†è¦ä»¥æœ€å¿«çš„é€Ÿåº¦å°†æ¨¡å‹è·‘èµ·æ¥å°±å°†æ‰€æœ‰ object ç±»å‹çš„ç‰¹å¾ drop æ‰ã€‚ä¸è¦è€ƒè™‘æå–ç‰¹å¾ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>dtypes</code> æŸ¥çœ‹ä¸€ä¸ªDataFrame é‡Œé¢çš„æ•°æ®ç±»å‹ï¼Œé€šè¿‡ <code>isnull</code> æŸ¥çœ‹ DataFrame é‡Œæ•°æ®ä¸ºç©ºçš„æƒ…å†µã€‚</p>
<pre><code class="python">import os
import pandas as pd
test = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;round1_iflyad_test_feature.txt&#39;), sep=&#39;\t&#39;)
print(test.dtypes)
NAs = test.isnull().sum()
print(NAs[NAs &gt; 0])
</code></pre>
<p>è¿è¡Œä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code class="shell">instance_id                int64
time                       int64
...(å¤ªé•¿çœç•¥)
app_paid                    bool
advert_name               object
dtype: object

user_tags      13232
make            4126
...(å¤ªé•¿çœç•¥)
f_channel      36637
app_id            31
dtype: int64
</code></pre>
<p>æœ‰è¿™ä¸ªç»“æœæˆ‘ä»¬å°±èƒ½çŸ¥é“å“ªäº›æ˜¯æˆ‘ä»¬åº”è¯¥åˆ é™¤çš„ç‰¹å¾ï¼ˆæ¯”å¦‚ <code>advert_name</code>ï¼‰ï¼Œå“ªäº›æ˜¯æˆ‘ä»¬åº”è¯¥å¡«å……çš„ç¼ºå¤±å€¼ã€‚ç°åœ¨å°±å¯ä»¥è¿›è¡Œæ•°æ®é¢„å¤„ç†ï¼š</p>
<pre><code class="python">import os
import pandas as pd

def show_NaN(df):
    NAs = df.isnull().sum()
    print(NAs[NAs &gt; 0])

def fill_missings(df):
    df[&#39;make&#39;] = df[&#39;make&#39;].fillna(&#39;-1&#39;)
    df[&#39;model&#39;] = df[&#39;model&#39;].fillna(&#39;-1&#39;)
    df[&#39;osv&#39;] = df[&#39;osv&#39;].fillna(&#39;-1&#39;)
    df[&#39;app_cate_id&#39;] = df[&#39;app_cate_id&#39;].fillna(-1)
    df[&#39;app_id&#39;] = df[&#39;app_id&#39;].fillna(-1)
    df[&#39;click&#39;] = df[&#39;click&#39;].fillna(-1)
    df[&#39;user_tags&#39;] = df[&#39;user_tags&#39;].fillna(&#39;-1&#39;)
    df[&#39;f_channel&#39;] = df[&#39;f_channel&#39;].fillna(&#39;-1&#39;)
    return df

print(&#39;Begin to read database...&#39;)
train = pd.read_csv(os.path.join(&#39;Data&#39;,&#39;round1_iflyad_train.txt&#39;), sep=&#39;\t&#39;)
test = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;round1_iflyad_test_feature.txt&#39;), sep=&#39;\t&#39;)
all_data = pd.concat([train, test], sort=False)

print(&#39;Begin to do pretreatment...&#39;)
all_data = fill_missings(all_data)
numeric_feats = all_data.dtypes[all_data.dtypes == &#39;object&#39;].index
all_data = all_data.drop(numeric_feats, axis=1)

print(&#39;Begin to save database...&#39;)
print(all_data.dtypes)
print(all_data.shape)
show_NaN(all_data)
all_data[:train.shape[0]].to_csv(os.path.join(&#39;Data&#39;, &#39;train.csv&#39;), index=False)
all_data[train.shape[0]:].to_csv(os.path.join(&#39;Data&#39;, &#39;test.csv&#39;), index=False)
</code></pre>
<p><em>PSï¼šæˆ‘å°†æ‰€æœ‰æ•°æ®æ–‡ä»¶æ”¾å…¥äº†å½“å‰è·¯å¾„çš„ Data æ–‡ä»¶å¤¹ä¸­ï¼Œä½ å¯ä»¥é€‚åº”è‡ªå·±çš„æ–‡ä»¶è·¯å¾„ã€‚</em></p>
<p>é€‰æ‹©æ¨¡å‹è¿™æ–¹é¢æˆ‘ä¹ŸçŸ¥ä¹‹ç”šå°‘ï¼Œæ˜¯ä»¥ååº”è¯¥é‡ç‚¹è¡¥è¶³çš„ç‚¹ã€‚ä½†å¼€å§‹ä¸€ä¸ªæ¯”èµ›æ¨¡å‹å¤åˆ¶ <a href="https://zhuanlan.zhihu.com/p/44956113" target="_blank" rel="external">baseline</a> ï¼Œå¤§æ–¹å‘ä¸ä¼šé”™ã€‚</p>
<pre><code class="python">import os
import time
import datetime

import numpy as np
import pandas as pd

import warnings
warnings.filterwarnings(&#39;ignore&#39;)

def lgb_train(X_train, X_test, y):
    import lightgbm as lgb
    from sklearn.cross_validation import StratifiedKFold

    X_loc_train = X_train.values
    y_loc_train = y.values
    X_loc_test = X_test.values
    res = X_test.loc[:, [&#39;instance_id&#39;]]

    model = lgb.LGBMClassifier(
        boosting_type=&#39;gbdt&#39;, num_leaves=48, max_depth=-1, learning_rate=0.05,
        n_estimators=2000, max_bin=425, subsample_for_bin=50000, objective=&#39;binary&#39;,
        min_split_gain=0,min_child_weight=5, min_child_samples=10, subsample=0.8,
        subsample_freq=1, colsample_bytree=1, reg_alpha=3, reg_lambda=5, seed=1000, 
        n_jobs=10, silent=True)

    # äº”æŠ˜äº¤å‰è®­ç»ƒï¼Œæ„é€ äº”ä¸ªæ¨¡å‹
    baseloss = []
    for i, (train_index, test_index) in enumerate(list( \
        StratifiedKFold(y_loc_train, n_folds=5, shuffle=True, random_state=1024))):
        print(&#39;---Fold&#39;, i)
        lgb_model = model.fit(
            X_loc_train[train_index], y_loc_train[train_index],
            eval_names =[&#39;train&#39;, &#39;valid&#39;],
            eval_metric=&#39;logloss&#39;,
            eval_set=[
                (X_loc_train[train_index], y_loc_train[train_index]),
                (X_loc_train[test_index], y_loc_train[test_index])
            ],
            early_stopping_rounds=100
        )
        baseloss.append(lgb_model.best_score_[&#39;valid&#39;][&#39;binary_logloss&#39;])
        res[&#39;prob_%s&#39; % str(i)] = lgb_model.predict_proba(
            X_loc_test, num_iteration=lgb_model.best_iteration_)[:, 1]
        print(&#39;mean:&#39;, res[&#39;prob_%s&#39; % str(i)].mean())

    res[&#39;predicted_score&#39;] = res[[&#39;prob_&#39; + str(i) for i in range(5)]].mean(axis=1)
    print(&#39;logloss:&#39;, baseloss, np.mean(baseloss))
    print(&#39;mean:&#39;, res[&#39;predicted_score&#39;].mean())
    now = datetime.datetime.now().strftime(&#39;%m-%d-%H-%M&#39;)
    res[[&#39;instance_id&#39;, &#39;predicted_score&#39;]].to_csv(
        os.path.join(&#39;Submit&#39;, &#39;lgb_%s.csv&#39; % now), index=False)


print(&#39;Begin to read csv...&#39;)
train = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;train.csv&#39;))
test = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;test.csv&#39;))
all_data = pd.concat([train, test], sort=False)

print(&#39;Begin to plot database...&#39;)
X_train = all_data[:train.shape[0]].drop([&#39;click&#39;], axis=1)
X_test = all_data[train.shape[0]:].drop([&#39;click&#39;], axis=1)
y = train[&#39;click&#39;]

print(&#39;Begin to train...&#39;)
lgb_train(X_train, X_test, y)
</code></pre>
<p>è‡³äºä»€ä¹ˆæ˜¯LightGBã€ä»€ä¹ˆæ˜¯NæŠ˜äº¤å‰è®­ç»ƒï¼Œä»¥åå†å»å¼„æ˜ç™½ã€‚è¿™æ ·ç®—æ˜¯èƒ½è·‘å‡ºä¸€ä¸ªç»“æœäº†ã€‚</p>
<h3 id="æå–ç‰¹å¾"><a href="#æå–ç‰¹å¾" class="headerlink" title="æå–ç‰¹å¾"></a>æå–ç‰¹å¾</h3><p>åœ¨æœ‰ä¸€ä¸ªèƒ½è·‘é€šçš„æ¨¡å‹åŸºç¡€ä¸Šï¼Œæˆ‘è‚¤æµ…çš„è°ˆè°ˆç‰¹å¾å·¥ç¨‹ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹æ¯ä¸ªç‰¹å¾é‡Œé¢æœ‰å¤šå°‘ç±»å€¼ï¼š</p>
<pre><code class="python">df = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;round1_iflyad_train.txt&#39;), sep = &#39;\t&#39;)
print(df.nunique().sort_values())
</code></pre>
<pre><code class="shell">app_paid                       1
creative_is_voicead            1
...
nnt                            6
creative_height               13
creative_width                20
app_cate_id                   22
advert_industry_inner         24
advert_name                   34
province                      35
advert_id                     38
creative_tp_dnf               40
campaign_id                   64
f_channel                     73
osv                          300
city                         333
...
instance_id              1001650
dtype: int64
</code></pre>
<p>åƒ<code>creative_is_voicead</code>ã€<code>creative_is_js</code>ç±»åˆ«ä¸º1çš„é¡¹å°±å¯ä»¥ç›´æ¥å‰”é™¤æ‰ï¼›ç±»ä¼¼äº<code>creative_has_deeplink</code>è¿™æ ·çš„äºŒå€¼ç‰¹å¾ç›´æ¥ä½¿ç”¨é—®é¢˜ä¸ä¼šå¤ªå¤§ï¼›è€Œ<code>creative_width</code>è¿™æ ·çš„ç‰¹å¾ç›´æ¥ä¼ å…¥ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>ä»”ç»†è§‚å¯Ÿå°±ä¼šå‘ç°è¿™äº›ç‰¹å¾é‡Œé¢å…¨æ˜¯IDç±»ç¦»æ•£ç‰¹å¾ã€‚å¸¸ç†æ¥è¯´ï¼ŒIDç±»ç‰¹å¾æ˜¯ä¸èƒ½ç›´æ¥å¯¼å…¥æ¨¡å‹çš„ï¼Œè¿™æ ·çš„ç‰¹å¾è¦ä¹ˆ<a href="https://en.wikipedia.org/wiki/One-hot" target="_blank" rel="external">One-Hot</a>ã€è¦ä¹ˆå¯¹å…¶è¿›è¡Œæ’åºã€‚æˆ‘çš„ç‰¹å¾éƒ½æ˜¯å›´ç»•è¿™ä¸¤é¡¹å±•å¼€ã€‚One-Hotæ¯”è¾ƒç®€å•è€Œä¸”æ˜“äºç†è§£ï¼Œä»£è¡¨ç€å½“å‰ç±»åˆ«å¯¹Labelçš„å½±å“ï¼Œè¿™é‡Œä¸è¿‡å¤šå™è¿°ã€‚</p>
<p>é‡ç‚¹è¯´è¯´å¯¹IDæ’åºã€‚æ’åºæ˜¯å¸Œæœ›ä¸è§„åˆ™çš„IDä¸Labelå‘ˆçº¿æ€§å…³ç³»(å³IDè¶Šå¤§ç‚¹å‡»ç‡è¶Šé«˜ä¹‹ç±»)ï¼Œé‚£ä¹ˆå°±è¿™ä¸ªé—®é¢˜æ¥è¯´å¹¿å‘Šç‚¹å‡»ç‡ï¼ˆCTRï¼‰æ˜¯æœ€ä¸ºç›´æ¥çš„æ’åºæ–¹å¼ã€‚é¦–å…ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹ä¸åŒç‰¹å¾çš„CTRè¿›è¡Œä¸€äº›æµ‹éªŒï¼Œæ¯”å¦‚è€ƒè™‘ä¸åŒç±»å‹çš„å¹¿å‘Šç‚¹å‡»ç‡ä¸åŒï¼š</p>
<pre><code class="python">import matplotlib.pyplot as plt
df = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;round1_iflyad_train.txt&#39;), sep = &#39;\t&#39;)
res = df.groupby([&#39;creative_type&#39;])[&#39;click&#39;].mean().reset_index(name=&#39;creative_type_ctr&#39;)
print(res)
x, y = &#39;creative_type&#39;, &#39;creative_type_ctr&#39;
data = pd.concat([res[x], res[y]], axis=1)
data.plot.scatter(x=x, y=y, ylim=(0, 1))
plt.show()
</code></pre>
<div align="center"><br><img src="/assets/xunfei/creative_type_ctr.png" alt="image-20181008152344990"><br></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¼–å·ä¸ºç±»å‹2ã€3ã€5çš„å¹¿å‘Šç‚¹å‡»ç‡æ˜æ˜¾ä¸å¦‚ç±»å‹8ã€10çš„å¹¿å‘Šã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p>
<pre><code class="python">df = df.replace({
    &quot;creative_type&quot; : {2 : 1, 5 : 2, 3 : 3, 10 : 4, 8 : 5},
})
</code></pre>
<p>è¿™æ ·å¹¿å‘Šç±»å‹å’ŒLabelå°±æ­£ç›¸å…³äº†ã€‚æˆ‘ä»¬è¿˜å¯ä»¥çŒœæµ‹ç”¨æˆ·çš„ç½‘ç»œçŠ¶æ€ï¼ˆnntï¼‰ä¹Ÿä¸ç‚¹å‡»å¹¿å‘Šæœ‰å…³ç­‰ç­‰ã€‚</p>
<p>åƒè¿™æ ·ç®€å•çš„ç»™IDæ’åºä¼šæœ‰ä¸€å®šçš„æ•ˆæœï¼Œä½†æ˜¯å¯èƒ½ä»ä¸å°½ç†æƒ³ã€‚å› ä¸ºä¸åŒçš„äººä¼šå–œæ¬¢ä¸åŒçš„å¹¿å‘Šç±»å‹ï¼Œæ¯”å¦‚åŒ–å¦†å“ç±»å¹¿å‘Šå¯èƒ½ç‚¹å‡»ç‡å¾ˆé«˜ï¼Œä½†æ˜¯å¦‚æœæ¨é€ç»™ä¸åŒ–å¦†çš„äººç‚¹å‡»ç‡ä¼šå¤§å¤§é™ä½ã€‚ä¹Ÿå°±æ˜¯è¯´åŒä¸€ç±»å‹çš„å¹¿å‘Šå¯¹ä¸åŒçš„äººæ¥è¯´ç‚¹å‡»ç‡æ˜¯ä¸åŒçš„ï¼š</p>
<pre><code class="python">df = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;round1_iflyad_train.txt&#39;), sep = &#39;\t&#39;)

df[&#39;creative_type_nnt&#39;] = df[&#39;creative_type&#39;].astype(&#39;str&#39;).str.cat(
    df[&#39;nnt&#39;].astype(&#39;str&#39;), sep=&#39;_&#39;)
df[&#39;creative_type_nnt&#39;] = df[&#39;creative_type_nnt&#39;].map(dict(
    zip(df[&#39;creative_type_nnt&#39;].unique(), range(0, df[&#39;creative_type_nnt&#39;].nunique()))
)).astype(&#39;int32&#39;)
res = df.groupby([&#39;creative_type_nnt&#39;])[&#39;click&#39;].mean().reset_index(
    name=&#39;creative_type_nnt_ctr&#39;)
print(res)

x, y = &#39;creative_type_nnt&#39;, &#39;creative_type_nnt_ctr&#39;
data = pd.concat([res[x], res[y]], axis=1)
data.plot.scatter(x=x, y=y, ylim=(0, 1))
plt.show()
</code></pre>
<p>é‚£ä¹ˆå°†<code>creative_type</code>å’Œ<code>nnt</code>æ‹¼æ¥èµ·æ¥å¹¶é‡æ–°ç¼–å·IDï¼ˆåˆ©äºè¾“å‡ºï¼‰ï¼Œå¾—åˆ°ä¸‹å›¾ï¼š</p>
<div align="center"><br><img src="/assets/xunfei/creative_type_nnt1.png" alt="image-20181012222022389"><br></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›¸æ¯”äºä¹‹å‰çš„<code>creative_type</code>ï¼Œç°åœ¨æ¯ä¸ªIDçš„åŒºåˆ†åº¦æ›´å¤§ï¼Œä½†æ˜¯å¥½åƒå¼€å§‹æ— æ³•åˆ†è¾¨<code>creative_type</code>ä¹‹é—´çš„å…³ç³»äº†ã€‚è¿™æ˜¯å› ä¸ºä¸€ç»´åªèƒ½æè¿°ä¸€ç§æ’åºå…³ç³»ï¼Œè¦æƒ³å®ç°ç‰¹å¾æ‹¼æ¥è€Œå°½é‡ä¸ä¸¢å¤±åŸå§‹ä¿¡æ¯å°±åº”è¯¥ä½¿ç”¨One-Hotè½¬åŒ–ä¸ºå¤šç»´æ¥è¡¨ç¤ºä¸åŒçš„<code>creative_type</code>ï¼Œç±»ä¼¼äºä¸‹é¢å®ç°ï¼š</p>
<pre><code class="python">df = pd.read_csv(os.path.join(&#39;Data&#39;, &#39;round1_iflyad_train.txt&#39;), sep = &#39;\t&#39;)
res = df.groupby([&#39;creative_type&#39;, &#39;nnt&#39;])[&#39;click&#39;].mean().reset_index(
    name=&#39;creative_type_nnt_ctr&#39;)
print(res)

x, y = &#39;nnt&#39;, &#39;creative_type_nnt_ctr&#39;
data = pd.concat([res[x], res[y]], axis=1)
data.plot.scatter(x=x, y=y, ylim=(0, 1))
plt.show()
</code></pre>
<p>é€šè¿‡ä¸‹å›¾å°±å¯ä»¥çœ‹å‡ºåœ¨<code>creative_type</code>ç›¸åŒæ—¶ï¼Œ<code>nnt</code>ä¸åŒCTRä¸åŒã€‚è¿™å°±å¯ä»¥è¡¨ç¤ºä¸åŒ<code>nnt</code>åœ¨åŒä¸€<code>creative_type</code>ä¸‹çš„åå¥½ï¼š</p>
<p><img src="/assets/xunfei/creative_type_nnt_ctr.png" alt="image-20181012220853867"></p>
<p>é€šè¿‡ä¸Šå›¾åˆå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨<code>creative_type</code>ä¸º10çš„æ—¶å€™æœ‰ä¸€ä¸ªç‚¹çš„ctrå€¼ä¸º1ã€‚æˆ‘ä»¬æŸ¥çœ‹è¿™ä¸ªç‚¹çš„å®é™…ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code class="shell">creative_type   nnt        ctr     count
           10     2   1.000000         1
</code></pre>
<p><code>creative_type=10 &amp; nnt=2</code>æƒ…å†µçš„ç‚¹å‡»ç‡ä¸º1ï¼Œä½†æ˜¯åªå‘ç”Ÿäº†1æ¬¡ã€‚å¾ˆæ˜æ˜¾è¿™ä¸ªç‚¹å‡»ç‡ä¸å¯ä¿¡ï¼Œè¿™æ—¶å°±è¦ç”¨åˆ°å¹³æ»‘å¤„ç†ï¼Œå»å°è¯•é¢„æµ‹çœŸå®çš„ç‚¹å‡»ç‡ã€‚</p>
<p>åœ¨ä¸€è¡Œæ•°æ®åœ¨æŸä¸€ç‰¹å¾ä¸‹å‡ºç°æ¬¡æ•°å¯èƒ½å¾ˆå°‘ï¼ˆæ¯”å¦‚<code>model</code>ï¼‰ï¼Œä½†æ˜¯åœ¨å¦ä¸€äº›ç‰¹å¾ä¸‹å‡ºç°æ¬¡æ•°ä¼šç›¸å¯¹è¾ƒå¤šï¼ˆå¦‚<code>nnt</code>ï¼‰ã€‚æˆ‘ä»¬è¯´å‡ºç°æ¬¡æ•°å°‘çš„ç‰¹å¾å¯ä¿¡åº¦ä½ï¼Œå‡ºç°æ¬¡æ•°å¤šçš„ç‰¹å¾å¯ä¿¡åº¦é«˜ã€‚ç”¨å¯ä¿¡åº¦é«˜çš„ç‰¹å¾å»é¢„æµ‹å¯ä¿¡åº¦ä½çš„ç‰¹å¾çš„ç‚¹å‡»ç‡ä¹Ÿè®¸å¯è¡Œï¼š</p>
<pre><code class="python">def get_ctr_matrix(data, src, dest):
    temp = data.loc[data[&#39;label&#39;] != -1, [src, dest, &#39;label&#39;]]

    src_gb = temp.groupby([src])
    src_frame = src_gb.agg({&#39;label&#39;: &#39;sum&#39;}).rename(
        columns={&#39;label&#39;: &#39;src_sum&#39;}).join(
        src_gb.agg({&#39;label&#39;: &#39;count&#39;}).rename(
        columns={&#39;label&#39;: &#39;src_count&#39;})).reset_index()
    del src_gb

    dest_gb = temp.groupby([src, dest])
    dest_frame = dest_gb.agg({&#39;label&#39;: &#39;sum&#39;}).rename(
        columns={&#39;label&#39;: &#39;dest_sum&#39;}).join(
        dest_gb.agg({&#39;label&#39;: &#39;count&#39;}).rename(
        columns={&#39;label&#39;: &#39;dest_count&#39;})).reset_index()
    del dest_gb

    frame = pd.merge(src_frame, dest_frame, on=[src], how=&#39;right&#39;)
    del temp, src_frame, dest_frame

    frame[&#39;rate&#39;] = (frame[&#39;src_sum&#39;] + frame[&#39;dest_sum&#39;]) / (frame[&#39;src_count&#39;] + frame[&#39;dest_count&#39;])
    frame.drop([&#39;src_sum&#39;, &#39;src_count&#39;, &#39;dest_sum&#39;, &#39;dest_count&#39;], axis=1, inplace=True)
    data = pd.merge(data, frame, on=[src, dest], how=&#39;left&#39;).fillna(0)
    del frame

    src_hot = pd.get_dummies(data[src], dtype=&#39;float32&#39;)
    for h in src_hot.columns:
        src_hot[h] *= data[&#39;rate&#39;]
    data.drop([&#39;rate&#39;], axis=1, inplace=True)

    return sparse.csr_matrix(src_hot[data[&#39;label&#39;] != -1], dtype=&#39;float32&#39;), sparse.csr_matrix(src_hot[data[&#39;label&#39;] == -1], dtype=&#39;float32&#39;)


ctr_list = [
    (&#39;creative_width&#39;, &#39;app_id&#39;),
    (&#39;nnt&#39;, &#39;creative_id&#39;),
]

ctr_train_csr = sparse.csr_matrix((len(train_x), 0))
ctr_predict_csr = sparse.csr_matrix((len(predict), 0))
for (src, dest) in ctr_list:
    ctr_t, ctr_p = get_ctr_matrix(data, src, dest)
    ctr_train_csr = sparse.hstack((ctr_train_csr, ctr_t), &#39;csr&#39;, &#39;float32&#39;)
    ctr_predict_csr = sparse.hstack((ctr_predict_csr, ctr_p), &#39;csr&#39;, &#39;float32&#39;)
    print(src, dest, &#39;over&#39;)
print(&#39;ctr feature prepared !&#39;)
</code></pre>
<p>PSï¼šæœ¬æ¥ç”±äºç»´æ•°è¿‡å¤§ï¼Œç¬”è®°æœ¬8Gå†…å­˜ä¸å¤Ÿç”¨ï¼Œå·®ç‚¹åœ¨è¿™é‡Œå¼ƒèµ›ã€‚åæ¥æ—æœ‰å¤•å¼€æºæ•‘æˆ‘ä¸€å‘½ï¼Œç”¨åˆ°äº†CSRã€‚</p>
<p>åœ¨æ­¤ä¹‹åå‡ºç°äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼šè‹¥ä¸€ä¸ªå¯ä¿¡åº¦é«˜çš„ç±»åˆ«è½¬åŒ–ç‡ä¸å¯ä¿¡åº¦ä½çš„çŒœæµ‹è½¬åŒ–ç‡æ˜¯ç›¸åŒçš„ï¼Œå¯é‡è¦æ€§åº”è¯¥ä¸ä¸€æ ·ã€‚å½“å‰ç‰¹å¾æ²¡æœ‰ä½“ç°è¿™ä¸ªåŒºåˆ«ã€‚æœ€åé€šè¿‡åŠ å…¥æ¯ä¸ªç±»åˆ«æ•°é‡åœ¨å…¨é›†ä¸­çš„å æ¯”æ¥åæ˜ ä¸€ä¸ªå¹¿å‘Šæ¨é€çš„ç½®ä¿¡åº¦ã€‚è§£å†³äº†åŒä¸€è½¬åŒ–ç‡ä¸‹ï¼Œä¸åŒç±»åˆ«å¯ä¿¡åº¦ä¸åŒçš„é—®é¢˜ã€‚</p>
<p>æœ€åï¼Œä¹Ÿæ˜¯æˆ‘æ²¡æœ‰å®Œæˆçš„é—®é¢˜ï¼šå¦‚ä½•è§£å†³é’ˆå¯¹ç”¨æˆ·ç‚¹å‡»ç‡è®¡ç®—çš„å¤šæ ·åŒ–ã€‚å½“å‰æŠ•æ”¾ç‰¹å¾ä¸»è¦é›†ä¸­åœ¨å¹¿å‘Šæ–¹å’ŒAPPæ–¹ï¼Œè®¡ç®—ä¸åŒç±»äººçš„åå¥½åº”è¯¥èƒ½ä¼˜åŒ–è¿™ç§æƒ…å†µã€‚</p>
<h3 id="æ€è€ƒä¸æ€»ç»“"><a href="#æ€è€ƒä¸æ€»ç»“" class="headerlink" title="æ€è€ƒä¸æ€»ç»“"></a>æ€è€ƒä¸æ€»ç»“</h3><ol>
<li>æ— è®ºæ˜¯æ¯”èµ›è¿‡ç¨‹ä¸­è¿˜æ˜¯æ¯”èµ›ç»“æŸåï¼Œæ·±åˆ‡ä½“ä¼šåˆ°è‡ªå·±ç†è®ºçŸ¥è¯†çš„ç¼ºä¹ã€‚</li>
<li>ç¦»æ•£ç‰¹å¾åšè¿ç»­åŒ–æ˜¯ä¸»è¦æ€è·¯ã€‚</li>
<li>ç¼ºå¤±å€¼å¯ä»¥å¡«å……meanï¼Œå¡«å……æ–°ç±»åˆ«ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–ç‰¹å¾é¢„æµ‹ã€‚</li>
<li>Baselineæœ‰æ—¶å€™æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œæœ‰æ—¶å€™ä¼šè¢«éª—ã€‚</li>
<li>è‚çœŸçš„èƒ½å¼¥è¡¥ä¸€äº›ä¸œè¥¿ï¼Œä½†ä¸æ˜¯å…¨éƒ¨ã€‚</li>
</ol>
<h3 id="æœ‰è¶£çš„é“¾æ¥"><a href="#æœ‰è¶£çš„é“¾æ¥" class="headerlink" title="æœ‰è¶£çš„é“¾æ¥"></a>æœ‰è¶£çš„é“¾æ¥</h3><ul>
<li><a href="http://www.dcjingsai.com/common/cmpt/2018%E7%A7%91%E5%A4%A7%E8%AE%AF%E9%A3%9EAI%E8%90%A5%E9%94%80%E7%AE%97%E6%B3%95%E5%A4%A7%E8%B5%9B_%E7%AB%9E%E8%B5%9B%E4%BF%A1%E6%81%AF.html" target="_blank" rel="external">2018ç§‘å¤§è®¯é£AIè¥é”€ç®—æ³•å¤§èµ›</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/27033340" target="_blank" rel="external">è½¬è½½æ–‡ç« </a></li>
<li><a href="https://zhuanlan.zhihu.com/p/44956113" target="_blank" rel="external">baseline</a></li>
</ul>

  </div>
</article>
<blockquote class="top-gap-big"> <p> æœ¬æ–‡éµå¾ª <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" class"text-muted">CC BY-ND-ND 3.0</a> åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜åŸä½œè€…ï¼Œç¦æ­¢å•†ç”¨ï¼Œç¦æ­¢æ¼”ç»ã€‚ </p> </blockquote>
<div class="top-gap-big text-center text-muted">
  <small>
    <i class="czs-tag-l"></i>
    <a class="text-muted" href="/tags/Data-Analysis/">Data Analysis</a>
  </small>
</div>


  <div id="disqus_thread" class="top-gap-big"></div>
  <script>
    var langMap = {
      en: 'en',
      'zh-CN': 'zh'
    };
    var disqus_config = function () {
      this.language = langMap['zh-CN'] || langMap['en'];
      this.page.url = 'https://freder-chen.github.io/2018/10/29/å¦‚ä½•å¼€å§‹ä¸€åœºæ•°æ®åˆ†ææ¯”èµ›/';
      this.page.identifier = '2018/10/29/å¦‚ä½•å¼€å§‹ä¸€åœºæ•°æ®åˆ†ææ¯”èµ›/';
      this.page.title = 'å¦‚ä½•å¼€å§‹ä¸€åœºæ•°æ®åˆ†ææ¯”èµ›';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = '//Freder.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


        <hr class="top-gap-big"></hr>
<p class="text-center">
  <small class="text-muted">
    &copy;
    
      2017 -
    
    <span itemprop="copyrightYear">2019</span>
    <i class="czs-heart" style="color:red;"></i>
    <span itemprop="copyrightHolder">Freder</span>

    <br/>

    ç”± <a class="text-muted" href="https://hexo.io" title="Hexo">Hexo</a> å¼ºåŠ›é©±åŠ¨
    <span class="theme-separator">Â·</span>
    ä¸»é¢˜
    <a class="text-muted" href="https://github.com/xcatliu/hexo-theme-milk">Milk</a>
  </small>
</p>

      </div>
      <div class="theme-sidebar-mask theme-hide"></div>
<aside class="theme-sidebar-wrapper">
  <div class="container flex-left units-gap theme-header-container">
    
    <a class="unit-0 theme-icon-link" href="/archives" title="å½’æ¡£">
      <i class="czs-folder-l"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/categories" title="åˆ†ç±»">
      <i class="czs-bookmark-l"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/tags" title="æ ‡ç­¾">
      <i class="czs-tag-l"></i>
    </a>
  
    <div class="unit"></div>
  
    <a class="unit-0 theme-icon-link" href="https://freder-chen.github.io" title="å…³äºæˆ‘">
      <i class="czs-user-l"></i>
    </a>
  

  </div>
  <div class="container">
    
          <h2>Frederçš„åšå®¢</h2>
          
          <p class="top-gap-0 text-muted">bibibi~bibi~bi~</p>
          
          <div class="flex-left flex-middle top-gap">
            <img alt="Avatar" height="24" src="/assets/about/freder.jpg"/>
            <span class="theme-sidebar-author">Freder</span>
          </div>
          
          <p>Welcome to there!</p>
          
          <p class="theme-sidebar-social">
            
    <a class="unit-0 theme-icon-link" href="https://github.com/freder-chen" title="GitHub">
      <i class="czs-github"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/atom.xml" title="RSS è®¢é˜…">
      <i class="czs-rss"></i>
    </a>
  

          </p>
          
          <h5>å‹æƒ…é“¾æ¥</h5>
          <p class="text-muted">
            <small>
              <ul class="theme-list-style-none">
                <li><a class="text-muted" href="https://blog.crazyforcode.org/">CFC Studio</a></li><li><a class="text-muted" href="https://blog.windisco.com/">æ‰§ä¸€ ã“ã“ã‚ ğŸ¥</a></li><li><a class="text-muted" href="/links">More</a></li>
              </ul>
            </small>
          </p>
          
  </div>
</aside>

    </div>
	
    <script src="/js/theme.js"></script>
    

    
  <script id="dsq-count-scr" src="//Freder.disqus.com/count.js" async></script>

  </body>
</html>
